# My Spellbook

A two-column spellbook web application with a grimoire aesthetic, built with Vite (vanilla JS) and Express API.

## Features

- **Spell Management**: Full CRUD operations for spells
- **Pagination**: Load spells in pages of 20
- **Search & Sort**: Client-side filtering and sorting
- **Grimoire Aesthetic**: Parchment background, ink borders, wax seal-style element chips
- **Real-time Updates**: Instant UI updates on save/delete

## Tech Stack

- **Frontend**: Vite + Vanilla JavaScript
- **Backend**: Express.js API
- **Storage**: JSON file persistence
- **Styling**: Custom CSS with grimoire theme

## Installation

1. Install root dependencies:
```bash
npm install
```

2. Install server dependencies:
```bash
cd server
npm install
cd ..
```

## Local Run

Run both the frontend and backend servers simultaneously:

```bash
npm run dev:all
```

This will start:
- **Frontend**: Vite dev server on `http://localhost:5173`
- **Backend**: Express API on `http://localhost:5174`

Alternatively, run them separately:
- Frontend only: `npm run dev`
- Backend only: `npm run dev:server`

The frontend uses `VITE_API_BASE_URL` when set, otherwise it defaults to `http://localhost:5174`.

## Deploy API to Render

1. Set the Render service root to `server/`.
2. Build command: `npm install`
3. Start command: `npm run start`
4. Environment variables:
   - `PORT` is provided by Render automatically.
   - Optional: `NODE_ENV=production`

### CORS (production)

The API allows browser requests **only** from:
- `http://localhost:5173`
- `https://spell-book.pages.dev`

Disallowed origins are not given CORS headers (the request still returns a normal HTTP response; the browser blocks access).

## Deploy Frontend to Cloudflare Pages

- Build command: `npm run build`
- Build output directory: `dist`
- Environment variables:
  - `VITE_API_BASE_URL=https://YOUR_RENDER_SERVICE_URL`

## Verify Deployment

- Visit `https://YOUR_RENDER_SERVICE_URL/health` and confirm `{ "ok": true }`.
- In the browser Network tab, confirm requests go to your Render API URL (not localhost).

### CORS / preflight verification (curl)

Replace the API base URL below with your Render URL if different:

```bash
API_BASE="https://spell-book-api-chag.onrender.com"
ORIGIN="https://spell-book.pages.dev"

# Basic health check (no Origin header)
curl -i "$API_BASE/health"

# CORS: allowed origin should get Access-Control-Allow-Origin
curl -i -H "Origin: $ORIGIN" "$API_BASE/health"

# Preflight: should return 204 with allow headers/methods
curl -i -X OPTIONS \
  -H "Origin: $ORIGIN" \
  -H "Access-Control-Request-Method: GET" \
  -H "Access-Control-Request-Headers: Content-Type" \
  "$API_BASE/health"

# Debug route (useful when troubleshooting CORS on production)
curl -i -H "Origin: $ORIGIN" "$API_BASE/debug"
```

Expected headers (for the allowed origin):
- `Access-Control-Allow-Origin: https://spell-book.pages.dev`
- `Access-Control-Allow-Methods` includes `GET`
- `Access-Control-Allow-Headers` includes `Content-Type`
- `OPTIONS` returns `204`

## API Endpoints

All endpoints are served from the API base URL (default `http://localhost:5174`).

### GET /spells
Get paginated list of spells.

**Query Parameters:**
- `limit` (optional, default: 20): Number of spells to return (1-100)
- `offset` (optional, default: 0): Number of spells to skip

**Response:**
```json
{
  "items": [Spell],
  "total": number
}
```

### GET /spells/:id
Get a single spell by ID.

**Response:**
```json
Spell
```

### POST /spells
Create a new spell.

**Request Body:**
```json
{
  "name": "string (required)",
  "element": "Arcane" | "Fire" | "Frost" | "Storm" | "Nature",
  "rarity": "Common" | "Uncommon" | "Rare" | "Mythic",
  "manaCost": number,
  "cooldownSec": number,
  "description": "string",
  "ingredients": ["string"]
}
```

**Response:**
```json
Spell (with generated id, createdAt, updatedAt)
```

### PUT /spells/:id
Update an existing spell.

**Request Body:** Same as POST (all fields optional except those being updated)

**Response:**
```json
Spell (with updated updatedAt)
```

### DELETE /spells/:id
Delete a spell.

**Response:**
```json
{
  "ok": true
}
```

### GET /health
Health check endpoint.

**Response:**
```json
{
  "ok": true
}
```

## Data Model

### Spell
```typescript
{
  id: string;                    // UUID, generated by server
  name: string;                  // Required
  element: "Arcane" | "Fire" | "Frost" | "Storm" | "Nature";
  rarity: "Common" | "Uncommon" | "Rare" | "Mythic";
  manaCost: number;              // Non-negative
  cooldownSec: number;           // Non-negative
  description: string;
  ingredients: string[];         // Array of strings
  createdAt: string;             // ISO timestamp, generated by server
  updatedAt: string;             // ISO timestamp, updated on PUT
}
```

## Application Flow

### Pagination
- Initial load fetches first 20 spells (limit=20, offset=0)
- "Load More" button appends next page to the list
- Server returns total count for display

### Search & Sort
- **Search**: Client-side filtering on loaded spells by name, description, or element
- **Sort**: Client-side sorting by name (A-Z or Z-A toggle)
- Both operations work on the currently loaded spells array

### CRUD Operations

**Create:**
1. Click "New Spell" → form clears with defaults
2. Fill in details
3. Click "Save" → POST request → spell added to list

**Read:**
1. Click spell card → GET request → form populates
2. Initial load fetches paginated list

**Update:**
1. Select existing spell
2. Modify form fields
3. Click "Save" → PUT request → list updates

**Delete:**
1. Select existing spell
2. Click "Delete" → confirmation dialog
3. Confirm → DELETE request → removed from list, editor clears

## Storage

Spells are persisted to `server/data/spells.json`. The file is created automatically if it doesn't exist. The server maintains an in-memory cache for fast access and writes to disk on every modification.

## Error Handling

- Network errors display toast notifications
- Validation errors return 400 status with error messages
- Not found errors return 404 status
- Server errors return 500 status
- All errors use consistent JSON format: `{ "message": "..." }`

## Project Structure

```
Spell-book/
├── package.json              # Root package with concurrently scripts
├── vite.config.js            # Vite configuration
├── index.html                # Main HTML file
├── src/
│   ├── main.js               # Application bootstrap and event handlers
│   ├── state.js              # State management
│   ├── api.js                # API fetch helpers
│   ├── config.js             # API base URL config
│   ├── ui.js                 # UI rendering functions
│   └── styles.css            # Grimoire aesthetic styling
└── server/
    ├── package.json           # Server dependencies
    ├── app.js                 # Express app + routes
    ├── index.js               # Server entrypoint
    ├── storage.js             # JSON file persistence
    └── data/
        └── spells.json        # Persisted spell data (auto-created)
```
